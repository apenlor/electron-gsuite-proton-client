<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Menu</title>
    <style>
      :root {
        --background-color: #202124;
        --accent-color-active: rgba(255, 255, 255, 0.1);
        --accent-color-hover: rgba(255, 255, 255, 0.05);
        --badge-color: #db4437;
        --font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --button-width: 58px;
        --button-height: 52px;
        --button-radius: 12px;
        --badge-size: 18px;
        --badge-offset: 6px;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        font-family: var(--font-family);
      }

      body {
        background-color: var(--background-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 15px;
        box-sizing: border-box;
        /* Allow clicking everywhere */
        -webkit-app-region: no-drag;
        user-select: none;
      }

      .icon-container {
        position: relative;
        margin-bottom: 15px;
      }

      .nav-button {
        width: var(--button-width);
        height: var(--button-height);
        border: none;
        border-radius: var(--button-radius);
        background-color: transparent;
        cursor: pointer;
        outline: none;
        opacity: 0.7;
        transition: all 0.2s ease-in-out;
      }

      .nav-button.active {
        opacity: 1;
        background-color: var(--accent-color-active);
        transform: scale(1.05);
      }

      .nav-button:not(.active):hover {
        opacity: 1;
        background-color: var(--accent-color-hover);
      }

      .nav-button img {
        width: 65%;
        height: 65%;
        pointer-events: none;
      }

      .badge {
        position: absolute;
        top: var(--badge-offset);
        right: var(--badge-offset);
        background-color: var(--badge-color);
        color: white;
        border-radius: 50%;
        min-width: var(--badge-size);
        height: var(--badge-size);
        font-size: 11px;
        line-height: var(--badge-size);
        font-weight: bold;
        text-align: center;
        padding: 0 4px;
        pointer-events: none;
        transform: scale(0);
        transition: transform 0.2s ease-in-out;
      }

      .badge.visible {
        transform: scale(1);
      }

      .spacer {
        flex-grow: 1;
      }

      .nav-button.loading {
        position: relative;
      }

      .nav-button.loading::after {
        content: "";
        position: absolute;
        bottom: 4px;
        left: 50%;
        transform: translateX(-50%);
        width: 4px;
        height: 4px;
        background-color: var(--badge-color);
        border-radius: 50%;
        animation: pulse 1.5s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 0.4;
          transform: translateX(-50%) scale(1);
        }
        50% {
          opacity: 1;
          transform: translateX(-50%) scale(1.5);
        }
      }
    </style>
  </head>
  <body>
    <!-- Dynamic Content Container -->
    <div
      id="menu-root"
      style="
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
      "
    ></div>

    <script type="module">
      class MenuController {
        constructor() {
          this.container = document.getElementById("menu-root");
          this.activeServiceId = null;
          this._setupIpcListeners();
          this._bindGlobalEvents();
        }

        _bindGlobalEvents() {
          // Left Click: Navigation
          this.container.addEventListener("click", (event) => {
            const button = event.target.closest(".nav-button");
            if (!button) return;

            const serviceId = button.parentElement.dataset.serviceId;
            if (serviceId) {
              window.electronAPI.send("switch-tab", serviceId);
              this.setActiveButton(serviceId);
            }
          });

          // Right Click: Context Menu (Settings)
          window.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            window.electronAPI.send("show-context-menu");
          });
        }

        _setupIpcListeners() {
          // Receive configuration from Main to build the UI
          window.electronAPI.on(
            "get-enabled-services",
            ({ activeId, services, config }) => {
              this.buildMenu(services, config);
              if (activeId) {
                this.setActiveButton(activeId);
              }
            },
          );

          window.electronAPI.on("set-active-tab", (serviceId) =>
            this.setActiveButton(serviceId),
          );

          window.electronAPI.on("update-menu-badges", (counts) =>
            this.updateBadges(counts),
          );

          window.electronAPI.on("update-menu-icon", ({ source, dataUrl }) =>
            this.updateIcon(source, dataUrl),
          );

          window.electronAPI.on("set-loading-state", ({ serviceId, loading }) =>
            this.setLoadingState(serviceId, loading),
          );
        }

        buildMenu(enabledServices, viewConfig) {
          this.container.innerHTML = "";

          // 1. Render Primary Apps (Top: Gmail, Chat)
          Object.values(viewConfig).forEach((conf) => {
            if (!conf.isContent) return;
            if (!enabledServices[conf.id]) return;
            if (conf.id === "drive") return; // Skip Drive, render it later

            this._createButton(conf);
          });

          // 2. Add Spacer to push Drive to bottom
          const spacer = document.createElement("div");
          spacer.className = "spacer";
          this.container.appendChild(spacer);

          // 3. Render Drive (Bottom)
          const driveConf = Object.values(viewConfig).find(
            (c) => c.id === "drive",
          );
          if (driveConf && enabledServices.drive) {
            this._createButton(driveConf);
          }
        }

        _createButton(conf) {
          const div = document.createElement("div");
          div.className = "icon-container";
          div.dataset.serviceId = conf.id;

          div.innerHTML = `
          <button class="nav-button" title="${conf.title}">
            <img src="${conf.icon}" alt="${conf.title}" data-icon-id="${conf.id}" />
          </button>
          <span class="badge" data-badge-id="${conf.id}"></span>
        `;
          this.container.appendChild(div);
        }

        setActiveButton(serviceId) {
          if (this.activeServiceId === serviceId) return;

          if (this.activeServiceId) {
            this.container
              .querySelector(
                `[data-service-id="${this.activeServiceId}"] .nav-button`,
              )
              ?.classList.remove("active");
          }

          const newBtn = this.container.querySelector(
            `[data-service-id="${serviceId}"] .nav-button`,
          );
          if (newBtn) {
            newBtn.classList.add("active");
            this.activeServiceId = serviceId;
          }
        }

        updateBadges(counts) {
          for (const [serviceId, count] of Object.entries(counts)) {
            const badge = this.container.querySelector(
              `[data-badge-id="${serviceId}"]`,
            );
            if (!badge) continue;

            const hasUnread = count > 0;
            badge.classList.toggle("visible", hasUnread);

            if (hasUnread) {
              badge.textContent = count > 99 ? "99+" : count;
            }
          }
        }

        updateIcon(serviceId, dataUrl) {
          const icon = this.container.querySelector(
            `[data-icon-id="${serviceId}"]`,
          );
          if (icon) {
            icon.src = dataUrl;
          }
        }

        setLoadingState(serviceId, isLoading) {
          const button = this.container.querySelector(
            `[data-service-id="${serviceId}"] .nav-button`,
          );
          if (button) {
            button.classList.toggle("loading", isLoading);
          }
        }
      }

      new MenuController();
    </script>
  </body>
</html>
